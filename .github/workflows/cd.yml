name: Update metrics

on:
  push:
    branches:
      - main

jobs:
  notify_compass_metrics:
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: 🛠️ Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: ⬇️ Install yq using snap
        run: |
          sudo apt update
          sudo apt install -y snapd
          sudo snap install yq

      - name: ✅ Verify yq installation
        run: yq --version

      - name: 🔎 Fetch secrets
        env:
          COMPASS_USER_EMAIL: ${{ secrets.COMPASS_USER_EMAIL }}
          COMPASS_USER_API_KEY: ${{ secrets.COMPASS_USER_API_KEY }}
          COMPASS_METRICS_BASE_URL: ${{ secrets.COMPASS_METRICS_BASE_URL }}
        run: |
          echo "COMPASS_USER_EMAIL=$COMPASS_USER_EMAIL" >> $GITHUB_ENV
          echo "COMPASS_USER_API_KEY=$COMPASS_USER_API_KEY" >> $GITHUB_ENV
          echo "COMPASS_METRICS_BASE_URL=$COMPASS_METRICS_BASE_URL" >> $GITHUB_ENV

      - name: 📣 Notify Compass
        run: ./scripts/notify-compass.sh
